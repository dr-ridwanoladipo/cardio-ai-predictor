name: ğŸ©º Deploy Clinical Heart Disease AI to AWS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment (skip cache)'
        required: false
        default: 'false'
        type: boolean

env:
  ECR_REPOSITORY: cardio-ai-predictor
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: ğŸš€ Build & Deploy Medical AI System
    runs-on: ubuntu-latest

    steps:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“¥ CHECKOUT & SETUP
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better caching

    - name: ğŸ·ï¸ Generate deployment metadata
      id: meta
      run: |
        echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT
        echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "tag=sha-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        echo "commit_message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ” AWS AUTHENTICATION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
        mask-aws-account-id: 'no'

    - name: ğŸ”‘ Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ³ DOCKER BUILD & PUSH
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ¥ Build Clinical AI Docker Image
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.meta.outputs.tag }}
        FORCE_DEPLOY: ${{ github.event.inputs.force_deploy }}
      run: |
        # Define image URIs
        IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        LATEST_URI=$ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "ğŸ—ï¸ Building medical AI system..."
        echo "ğŸ“ Repository: $ECR_REPOSITORY"
        echo "ğŸ·ï¸ Tag: $IMAGE_TAG"
        echo "ğŸ“… Build date: ${{ steps.meta.outputs.build_date }}"
        echo "ğŸ’¬ Commit: ${{ steps.meta.outputs.commit_message }}"
        
        # Pull latest for layer caching (if not force deploy)
        if [ "$FORCE_DEPLOY" != "true" ]; then
          echo "ğŸš€ Pulling latest image for layer caching..."
          docker pull $LATEST_URI || echo "âš ï¸ No previous image found, building from scratch"
        fi
        
        # Build with metadata labels
        docker build \
          --cache-from $LATEST_URI \
          --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
          --label "org.opencontainers.image.version=$IMAGE_TAG" \
          --label "org.opencontainers.image.created=${{ steps.meta.outputs.build_date }}" \
          --label "org.opencontainers.image.revision=${{ github.sha }}" \
          --label "org.opencontainers.image.title=Clinical Heart Disease AI" \
          --label "org.opencontainers.image.description=Production ML system for cardiovascular risk assessment" \
          --label "maintainer=Ridwan Oladipo, MD" \
          --label "project=cardio-ai-predictor" \
          --tag $IMAGE_URI \
          --tag $LATEST_URI \
          .
        
        echo "âœ… Docker build completed successfully"
        echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
        
        # Push both tagged and latest versions
        echo "ğŸ“¤ Pushing images to ECR..."
        docker push $IMAGE_URI
        docker push $LATEST_URI
        
        echo "ğŸ‰ Images pushed successfully!"
        echo "ğŸ”— Tagged image: $IMAGE_URI"
        echo "ğŸ”— Latest image: $LATEST_URI"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“ ECS TASK DEFINITION UPDATE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ“ Update ECS task definition
      id: task-def
      env:
        IMAGE_URI: ${{ steps.build-image.outputs.image_uri }}
      run: |
        echo "ğŸ“‹ Updating task definition with new image..."
        echo "ğŸ–¼ï¸ New image URI: $IMAGE_URI"
        
        # Replace placeholder with actual image URI
        sed -i "s|REPLACE_IMAGE_URI|$IMAGE_URI|g" task-definition.json
        
        # Validate JSON syntax
        if ! python -m json.tool task-definition.json > /dev/null; then
          echo "âŒ Invalid JSON in task-definition.json"
          exit 1
        fi
        
        echo "âœ… Task definition updated successfully"
        
        # Display the updated image reference for verification
        echo "ğŸ” Updated task definition image:"
        grep -A 1 '"image":' task-definition.json || echo "âš ï¸ Could not find image reference"

    - name: ğŸš€ Register new ECS task definition
      id: register-task-def
      run: |
        echo "ğŸ“‹ Registering new task definition..."
        
        # Register the task definition and capture output
        TASK_DEF_OUTPUT=$(aws ecs register-task-definition \
          --cli-input-json file://task-definition.json \
          --query 'taskDefinition.{family:family,revision:revision,status:status}' \
          --output json)
        
        echo "ğŸ“„ Task definition registration result:"
        echo "$TASK_DEF_OUTPUT" | jq '.'
        
        # Extract family and revision
        FAMILY=$(echo "$TASK_DEF_OUTPUT" | jq -r '.family')
        REVISION=$(echo "$TASK_DEF_OUTPUT" | jq -r '.revision')
        TASK_DEF_ARN="$FAMILY:$REVISION"
        
        echo "âœ… New task definition registered:"
        echo "ğŸ“‹ Family: $FAMILY"
        echo "ğŸ”¢ Revision: $REVISION"
        echo "ğŸ†” ARN: $TASK_DEF_ARN"
        
        echo "task_def_arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ”„ ECS SERVICE DEPLOYMENT
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ¥ Deploy to ECS Fargate
      id: deploy-service
      env:
        TASK_DEF_ARN: ${{ steps.register-task-def.outputs.task_def_arn }}
      run: |
        echo "ğŸš€ Deploying medical AI service to ECS..."
        echo "ğŸ¯ Cluster: ${{ secrets.CLUSTER_NAME }}"
        echo "âš•ï¸ Service: ${{ secrets.SERVICE_NAME }}"
        echo "ğŸ“‹ Task Definition: $TASK_DEF_ARN"
        
        # Update the service with new task definition
        aws ecs update-service \
          --cluster "${{ secrets.CLUSTER_NAME }}" \
          --service "${{ secrets.SERVICE_NAME }}" \
          --task-definition "$TASK_DEF_ARN" \
          --force-new-deployment \
          --query 'service.{serviceName:serviceName,taskDefinition:taskDefinition,desiredCount:desiredCount,runningCount:runningCount}' \
          --output table
        
        echo "âœ… ECS service update initiated successfully!"

    - name: â±ï¸ Wait for deployment completion
      id: wait-deploy
      timeout-minutes: 15
      run: |
        echo "â³ Waiting for deployment to stabilize..."
        echo "ğŸ¥ This may take several minutes for medical AI system to fully initialize..."
        
        # Wait for service to reach steady state
        aws ecs wait services-stable \
          --cluster "${{ secrets.CLUSTER_NAME }}" \
          --services "${{ secrets.SERVICE_NAME }}"
        
        echo "âœ… Deployment completed successfully!"
        
        # Get final service status
        echo "ğŸ“Š Final service status:"
        aws ecs describe-services \
          --cluster "${{ secrets.CLUSTER_NAME }}" \
          --services "${{ secrets.SERVICE_NAME }}" \
          --query 'services[0].{serviceName:serviceName,status:status,runningCount:runningCount,desiredCount:desiredCount,taskDefinition:taskDefinition}' \
          --output table

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ” HEALTH CHECK & VALIDATION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ¥ Verify medical AI system health
      id: health-check
      run: |
        echo "ğŸ” Performing post-deployment health checks..."
        
        # Wait a bit for ALB to register new tasks
        echo "â³ Waiting 60 seconds for load balancer to register new tasks..."
        sleep 60
        
        # Test API health endpoint
        echo "ğŸ©º Testing API health endpoint..."
        for i in {1..5}; do
          if curl -f -s "https://cardio.mednexai.com/health" > /dev/null; then
            echo "âœ… API health check passed (attempt $i)"
            
            # Get detailed health info
            echo "ğŸ“Š API Health Status:"
            curl -s "https://cardio.mednexai.com/health" | jq '.' || echo "Could not parse health response"
            break
          else
            echo "âš ï¸ Health check failed (attempt $i/5), retrying in 30 seconds..."
            if [ $i -eq 5 ]; then
              echo "âŒ Health checks failed after 5 attempts"
              echo "ğŸ”§ Check ECS service logs and ALB target group health"
              exit 1
            fi
            sleep 30
          fi
        done
        
        echo "ğŸ‰ Medical AI system is healthy and ready!"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“Š DEPLOYMENT SUMMARY
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ©º CLINICAL HEART DISEASE AI - DEPLOYMENT SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“… Deployment Date: ${{ steps.meta.outputs.build_date }}"
        echo "ğŸ·ï¸ Image Tag: ${{ steps.meta.outputs.tag }}"
        echo "ğŸ“ Git Commit: ${{ github.sha }} (${{ steps.meta.outputs.short_sha }})"
        echo "ğŸ’¬ Commit Message: ${{ steps.meta.outputs.commit_message }}"
        echo "ğŸ‘¨â€âš•ï¸ Deployed by: ${{ github.actor }}"
        echo ""
        echo "ğŸ¯ Deployment Targets:"
        echo "   â€¢ Cluster: ${{ secrets.CLUSTER_NAME }}"
        echo "   â€¢ Service: ${{ secrets.SERVICE_NAME }}"
        echo "   â€¢ Task Definition: ${{ steps.register-task-def.outputs.task_def_arn }}"
        echo ""
        echo "ğŸŒ Production URLs:"
        echo "   â€¢ Main App: https://cardio.mednexai.com"
        echo "   â€¢ API Docs: https://cardio.mednexai.com/docs"
        echo "   â€¢ Health Check: https://cardio.mednexai.com/health"
        echo ""
        echo "ğŸ¥ System Status: ${{ job.status == 'success' && 'âœ… HEALTHY' || 'âŒ DEPLOYMENT FAILED' }}"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸš¨ NOTIFICATION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: ğŸš¨ Notify deployment status
      if: failure()
      run: |
        echo "ğŸš¨ DEPLOYMENT FAILED - Medical AI system deployment encountered errors!"
        echo "ğŸ”§ Please check the deployment logs and ECS service status immediately."
        echo "âš•ï¸ Patient safety may be impacted if the system is unavailable."
        echo ""
        echo "ğŸ” Troubleshooting steps:"
        echo "1. Check ECS service events: aws ecs describe-services --cluster ${{ secrets.CLUSTER_NAME }} --services ${{ secrets.SERVICE_NAME }}"
        echo "2. View container logs: Check CloudWatch logs at /ecs/cardio-ai-predictor"
        echo "3. Verify target group health: Check ALB target group health in AWS Console"
        echo "4. Test manual deployment: Consider manual rollback if needed"